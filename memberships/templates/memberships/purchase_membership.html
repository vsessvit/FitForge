{% extends "base.html" %}
{% load static %}

{% block extra_title %}- Purchase Membership{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/memberships.css' %}">
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <h1 class="text-center mb-4">Purchase Membership</h1>
            
            <!-- Membership Plan Details -->
            <div class="card membership-card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">{{ plan.name }}</h3>
                </div>
                <div class="card-body">
                    <p class="lead">{{ plan.description }}</p>
                    
                    <ul class="membership-benefits mb-4">
                        <li><i class="fas fa-check"></i> <strong>Price:</strong> ${{ plan.price }} / {{ plan.get_duration_display }}</li>
                        <li><i class="fas fa-check"></i> <strong>Classes per week:</strong> {{ plan.classes_per_week }}</li>
                        {% if plan.has_personal_training %}
                        <li><i class="fas fa-check"></i> Personal Training Sessions</li>
                        {% endif %}
                        {% if plan.has_nutrition_plan %}
                        <li><i class="fas fa-check"></i> Nutrition Plan Included</li>
                        {% endif %}
                        {% if plan.discount_percentage > 0 %}
                        <li><i class="fas fa-check"></i> {{ plan.discount_percentage }}% Discount on Merchandise</li>
                        {% endif %}
                    </ul>
                    
                    <div class="alert alert-info">
                        <strong>Total:</strong> ${{ plan.price }}
                    </div>
                </div>
            </div>
            
            <!-- Payment Form -->
            <div class="card membership-card">
                <div class="card-header">
                    <h4 class="mb-0">Payment Details</h4>
                </div>
                <div class="card-body">
                    <form id="payment-form" method="POST">
                        {% csrf_token %}
                        
                        <!-- Stripe Card Element -->
                        <div class="form-group">
                            <label for="card-element">Credit or Debit Card</label>
                            <div id="card-element" class="form-control" style="height: 40px; padding-top: 10px;">
                                <!-- Stripe Element will be inserted here -->
                            </div>
                            <div id="card-errors" class="text-danger mt-2" role="alert"></div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="auto-renew" name="auto_renew" checked>
                            <label class="form-check-label" for="auto-renew">
                                Automatically renew my membership
                            </label>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" id="submit-button" class="btn btn-lg btn-block">
                                <span id="button-text">Subscribe Now - ${{ plan.price }}</span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                            <a href="{% url 'memberships:membership_plans' %}" class="btn btn-outline-secondary btn-block mt-2">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="mt-3 text-center text-muted">
                <small><i class="fas fa-lock"></i> Secure payment powered by Stripe</small>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="d-none">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Processing...</span>
        </div>
        <p class="mt-3">Processing your membership...</p>
    </div>
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('{{ stripe_public_key }}');
    var elements = stripe.elements();
    
    // Create card element
    var style = {
        base: {
            color: '#32325d',
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#aab7c4'
            }
        },
        invalid: {
            color: '#fa755a',
            iconColor: '#fa755a'
        }
    };
    
    var card = elements.create('card', {style: style});
    card.mount('#card-element');
    
    // Handle real-time validation errors
    card.on('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
    
    // Handle form submission
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        var submitButton = document.getElementById('submit-button');
        var buttonText = document.getElementById('button-text');
        var spinner = document.getElementById('spinner');
        
        submitButton.disabled = true;
        spinner.classList.remove('d-none');
        buttonText.textContent = 'Processing...';
        
        // Create payment method and handle subscription
        stripe.createPaymentMethod({
            type: 'card',
            card: card,
        }).then(function(result) {
            if (result.error) {
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = 'Subscribe Now - ${{ plan.price }}';
            } else {
                // Send payment method to server
                handleSubscription(result.paymentMethod.id);
            }
        });
    });
    
    function handleSubscription(paymentMethodId) {
        // Show loading overlay
        document.getElementById('loading-overlay').classList.remove('d-none');
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Call backend to create subscription
        fetch('{% url "memberships:create_subscription" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                plan_id: {{ plan.id }},
                payment_method_id: paymentMethodId,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Redirect to confirmation page
            window.location.href = '{% url "memberships:activate_membership" plan.id %}';
        })
        .catch(error => {
            document.getElementById('loading-overlay').classList.add('d-none');
            var errorElement = document.getElementById('card-errors');
            errorElement.textContent = error.message || 'An error occurred. Please try again.';
            
            var submitButton = document.getElementById('submit-button');
            var buttonText = document.getElementById('button-text');
            var spinner = document.getElementById('spinner');
            
            submitButton.disabled = false;
            spinner.classList.add('d-none');
            buttonText.textContent = 'Subscribe Now - ${{ plan.price }}';
        });
    }
</script>
{% endblock %}
